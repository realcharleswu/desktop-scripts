#!/usr/bin/bash

usage () { echo "Usage: $0 [-s <starting directory>] [-v <vpn_directory>] [-c <0 for off>]" 1>&2; exit 1; }

invalid () { echo "Invalid argument to -c passed. Options: 0 for no clock, 1 for clock, omit the option for clock." 1>&2; exit 1; }

while getopts ":s:v:c:" o; do
    case "${o}" in
        s) # starting directory
            s=${OPTARG}
            ;;
        v) # vpn directory
            v=${OPTARG}
            ;;
        c)
		c=${OPTARG}
		((c == 0 || c == 1)) || invalid
		;;
	*) # anything else show usage
		usage
            ;;
    esac
done
#shift "$((OPTIND-1))"

DEFAULT_START_PATH="/home/kali/Practice/htb/rooms"
DEFAULT_VPN_PATH="/home/kali/Practice/vpn_files"
VPN_PATH="${DEFAULT_VPN_PATH}"
CLOCK_OPT=true
if [ ! -z "${s}" ]; then # user gave starting directory
	if [ -d "${s}" ]; then # starting directory exists
		cd "${s}"
	else # starting directory does not exist
		echo "[*] Starting Directory does not exist, creating ${s}..."
		mkdir "${s}" 2>/dev/null
		if [ -d "${s}" ]; then # directory successfully made
			echo "[*] ${s} creation successful. Setting directory..."; sleep 1;
			cd "${s}"
		else # directory not successfully made
			echo "[x] ${s} could not be made, aborting."
			exit 1
		fi
	fi
	echo "[*] Starting path set to ${s}."; sleep 1;
	else # user did not give starting directory
		echo "[*] Default starting directory (~/Practice/htb/rooms) used."; sleep 1;
	if [ -d "${DEFAULT_START_PATH}" ]; then # default start path exists
		cd "${DEFAULT_START_PATH}"
	else
		echo "[x] Default path ${DEFAULT_START_PATH} does not exist, provide one or create the directory. Aborting..."
		sleep 1
	fi
fi

if [ ! -z "${v}" ]; then # user gave vpn directory
	if [ -d "${v}" ]; then # vpn directory exists
		VPN_PATH="${v}"
	else # vpn directory does not exist
		echo "[*] VPN Directory does not exist, creating ${v}...";
		mkdir "${v}" 2>/dev/null
		if [ -d "${v}" ]; then # directory successfully made
			echo "[*] ${v} creation successful. Setting directory..."; sleep 1;
			VPN_PATH=${v}
		else # directory not successfully made
			echo "[x] ${v} could not be made, aborting."
			exit 1
		fi
	fi
	echo "[*] VPN path set to ${v}."; sleep 1;
	else # user did not give starting directory
		echo "[*] Default VPN directory (~/Practice/htb/vpn_files) used."; sleep 1;
	if [ -d "$DEFAULT_VPN_PATH" ]; then # default start path exists
		: # do nothing
	else
		echo "[x] Default VPN path ${DEFAULT_VPN_PATH} does not exist, provide one or create the directory. Aborting..."
		sleep 1
	fi
fi

if [ ! -z "${c}" ] && [ $c == 0 ]; then # -c arg exists and is 0 for false (no clock)
	echo "No clock mode enabled."; sleep 1;
	CLOCK_OPT=false
fi

session="pentest"

tmux new-session -d -s $session -n 'main'
tmux split-window -h
tmux split-window -v -p 33
if [ "${CLOCK_OPT}" = true ]; then
	tmux send-keys "tty-clock" Enter
fi
tmux new-window -d -t '=pentest' -n 'second'
tmux select-window -t $session:1
tmux split-window -h
tmux new-window -d -t '=pentest' -n 'openvpn'
tmux select-window -t $session:2
tmux send-keys "cd ${VPN_PATH}" Enter
tmux select-window -t $session:0
tmux select-pane -t 0
tmux attach

